{{- with resources.Get "js/main.js" }}
  {{- if eq hugo.Environment "development" }}
    {{- with . | js.Build }}
      <script src="{{ .RelPermalink }}"></script>
    {{- end }}
  {{- else }}
    {{- $opts := dict "minify" true }}
    {{- with . | js.Build $opts | fingerprint }}
      <script src="{{ .RelPermalink }}" integrity="{{- .Data.Integrity }}" crossorigin="anonymous"></script>
    {{- end }}
  {{- end }}
{{- end }}

<!-- JS & Library -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- KaTeX 数学公式支持 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

<!-- 代码块基础功能 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 数学公式渲染
    renderMathInElement(document.body, {
      delimiters: [
        {left: "$$", right: "$$", display: true},
        {left: "$", right: "$", display: false}
      ],
      throwOnError: false
    });
    
    // Enhanced code block with language label and copy button
    document.querySelectorAll('pre code').forEach(function(codeBlock) {
      // Get the programming language
      let language = '';
      codeBlock.className.split(' ').forEach(function(cls) {
        if (cls.startsWith('language-')) {
          language = cls.substring(9);
        }
      });
      
      // Get the original pre element and its parent container
      const pre = codeBlock.parentNode;
      const wrapper = pre.parentNode;
      
      // Create code block container
      const container = document.createElement('div');
      container.className = 'code-block-container';
      
      // Create header bar
      const header = document.createElement('div');
      header.className = 'code-block-header';
      
      // Display language label
      if (language) {
        const langLabel = document.createElement('span');
        langLabel.className = 'code-language-label';
        langLabel.textContent = language.toUpperCase();
        header.appendChild(langLabel);
      }
      
      // Add copy button
      const copyButton = document.createElement('button');
      copyButton.className = 'copy-button';
      copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg> Copy';
      
      copyButton.addEventListener('click', function() {
        // Get code content
        const code = codeBlock.textContent;
        
        // Copy to clipboard
        navigator.clipboard.writeText(code).then(function() {
          // Success, update button text
          copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Copied!';
          
          // Reset after 2 seconds
          setTimeout(function() {
            copyButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg> Copy';
          }, 2000);
        });
      });
      
      header.appendChild(copyButton);
      
      // Insert the container before the original pre element to keep layout order,
      // then move the pre inside the container.
      wrapper.insertBefore(container, pre);
      container.appendChild(header);
      container.appendChild(pre);
      
      // Apply syntax highlighting
      if (window.hljs) hljs.highlightElement(codeBlock);
    });
  });
</script>
<!-- 脚注返回链接支持 -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // 处理脚注返回链接
    const footnoteBacklinks = document.querySelectorAll('.footnote-backref');
    
    footnoteBacklinks.forEach(function(backlink) {
      backlink.addEventListener('click', function(e) {
        e.preventDefault();
        
        // 获取链接的href属性（格式为 #fnref:1 等）
        const href = backlink.getAttribute('href');
        
        if (href) {
          // 找到原文引用的元素
          const target = document.querySelector(href);
          
          if (target) {
            // 滚动到引用位置
            target.scrollIntoView({ behavior: 'smooth' });
            
            // 高亮显示引用位置（可选）
            target.classList.add('footnote-highlight');
            setTimeout(function() {
              target.classList.remove('footnote-highlight');
            }, 2000);
          }
        }
      });
    });
  });
</script>

<!-- 页内跳转目标高亮（TOC/哈希链接） -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // --- Theme (dark / light) ---
    (function themeInit() {
      const storageKey = 'theme';
      const root = document.documentElement;
      const btn = document.getElementById('theme-toggle');
      const hlLight = document.getElementById('hljs-theme-light');
      const hlDark = document.getElementById('hljs-theme-dark');

      function systemPrefersDark() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }

      function currentPref() {
        const v = localStorage.getItem(storageKey);
        if (v === 'dark') return 'dark';
        if (v === 'light') return 'light';
        return systemPrefersDark() ? 'dark' : 'light';
      }

      function apply(theme) {
        root.classList.toggle('dark', theme === 'dark');
        btn?.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
        if (btn) btn.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
        if (hlLight && hlDark) { hlLight.disabled = theme === 'dark'; hlDark.disabled = theme !== 'dark'; }
      }

      let theme = currentPref();
      apply(theme);

      btn?.addEventListener('click', function () {
        theme = theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem(storageKey, theme);
        apply(theme);
      });

      // Watch system preference changes when user has no explicit choice
      try {
        const media = window.matchMedia('(prefers-color-scheme: dark)');
        media.addEventListener?.('change', () => {
          const explicit = localStorage.getItem(storageKey);
          if (!explicit) { theme = currentPref(); apply(theme); }
        });
      } catch (_) {}
    })();
    let currentHighlighted = null;
    let scrollArmTimer = null;

    function removeHandlers() {
      window.removeEventListener('scroll', clearOnce);
      window.removeEventListener('keydown', clearOnce);
      window.removeEventListener('pointerdown', clearOnce);
      window.removeEventListener('touchstart', clearOnce);
    }

    function clearOnce() {
      if (currentHighlighted) {
        currentHighlighted.classList.remove('anchor-highlight');
        currentHighlighted = null;
      }
      removeHandlers();
    }

    function headerHeight() {
      const hd = document.querySelector('body > header');
      return hd ? hd.getBoundingClientRect().height : 0;
    }

    function scrollToTarget(el) {
      if (!el) return;
      const offset = headerHeight() + 8; // 头部高度 + 细微间距
      const rect = el.getBoundingClientRect();
      const top = window.pageYOffset + rect.top - offset;
      window.scrollTo({ top, behavior: 'smooth' });
    }

    function highlightById(id) {
      if (!id) return;
      try { id = decodeURIComponent(id); } catch (e) {}
      const el = document.getElementById(id);
      if (!el) return;
      const target = el; // 精确高亮目标元素自身（包括 span 等内联元素）
      if (currentHighlighted && currentHighlighted !== target) {
        currentHighlighted.classList.remove('anchor-highlight');
      }
      target.classList.add('anchor-highlight');
      currentHighlighted = target;
      // 高亮 TOC 中对应项
      setTocActive(id);
      scrollToTarget(target);
      // 下一次交互或超时清除
      removeHandlers();
      // 立刻监听键盘/指针，但延迟武装 scroll 清除，避免平滑滚动立即清掉高亮
      window.addEventListener('keydown', clearOnce, { once: true });
      window.addEventListener('pointerdown', clearOnce, { once: true });
      window.addEventListener('touchstart', clearOnce, { once: true });
      if (scrollArmTimer) clearTimeout(scrollArmTimer);
      scrollArmTimer = setTimeout(() => {
        window.addEventListener('scroll', clearOnce, { once: true });
      }, 1500);
    }

    // 页面初次加载带 hash
    if (location.hash && location.hash.length > 1) {
      // 等待初始布局完成再滚动与高亮
      setTimeout(() => highlightById(location.hash.slice(1)), 0);
    }

    // hash 变化时处理
    window.addEventListener('hashchange', function () {
      if (location.hash && location.hash.length > 1) {
        highlightById(location.hash.slice(1));
      }
    });

    // 事件委托：监听任意哈希内链（更稳健，兼容后续动态生成的目录等）
    document.addEventListener('click', function (e) {
      const a = e.target.closest('a[href^="#"]');
      if (!a) return;
      const href = a.getAttribute('href');
      if (!href || href === '#' || href.length < 2) return;
      const id = href.slice(1);
      if (!document.getElementById(id)) return; // 不是有效锚点
      e.preventDefault();
      if (history.pushState) { history.pushState(null, '', '#' + id); }
      else { location.hash = id; }
      highlightById(id);
    }, true);

    // 浏览器前进/后退时也处理
    window.addEventListener('popstate', function () {
      if (location.hash && location.hash.length > 1) highlightById(location.hash.slice(1));
    });

    function setTocActive(id) {
      try { id = decodeURIComponent(id); } catch (e) {}
      const toc = document.getElementById('TableOfContents');
      if (!toc) return;
      toc.querySelectorAll('a.toc-active').forEach(a => a.classList.remove('toc-active'));
      const link = toc.querySelector(`a[href="#${CSS.escape(id)}"]`);
      if (link) link.classList.add('toc-active');
    }
  });
</script>
